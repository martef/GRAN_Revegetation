---
title: "compile"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Compile datasets for GRAN revegetation project

```{r, }

library(readxl)
library(data.table)
library(tidyr)
#library(tibble)
library(dplyr)
library(ggplot2)
library(tidyverse)
#library(janitor)
#library(magrittr)
library(plyr)
```

# Import

```{r}
VSM2021 <- read_excel("C:/Users/martef/DokumenterIntern/GitHub/PhDGRAN/Data/Reveg_2021.xlsx",
                          sheet = "VSM_ruter_snudd", na = "0")

HM2021 <- read_excel("C:/Users/martef/DokumenterIntern/GitHub/PhDGRAN/Data/Reveg_2021.xlsx",
                          sheet = "HM_ruter_snudd", na = "0")

VSM2020 <- read_excel("C:/Users/martef/DokumenterIntern/GitHub/PhDGRAN/Data/Reveg_2020.xlsx",
                          sheet = "VM_ruter_snudd", na = "0")

HM2020 <- read_excel("C:/Users/martef/DokumenterIntern/GitHub/PhDGRAN/Data/Reveg_2020.xlsx",
                          sheet = "HM_ruter_snudd", na = "0")

```

Standardiserer de første 8 kolonnene like som i VSM2020
```{r}

names(VSM2020)[1:8]
```


```{r}
names(VSM2021)[1:8]
```

```{r}
Roughness <- NA
Helning <- NA
VSM2021 <- cbind(VSM2021[,1:6], Roughness, Helning, VSM2021[,7:ncol(VSM2021)])
names(VSM2021)[1:8]
```

```{r}
HM2021 <- cbind(HM2021[,1:6], Roughness, Helning, HM2021[,7:ncol(HM2021)])
names(HM2021)[1:8]
```
```{r}
names(HM2020)
Registrert <- NA
HM2020 <- cbind(HM2020[,1:2], Registrert, HM2020[,3:ncol(HM2020)])
names(HM2020)[1:8]

```
```{r}
names(VSM2020)[1:8]
```
Checking if columns are equal
```{r}
names(VSM2020)[1:8] ==  names(VSM2021)[1:8] 
names(VSM2020)[1:8] ==  names(HM2020)[1:8]
names(VSM2020)[1:8] ==  names(HM2021)[1:8]

```
Setting all variables as character
```{r}
VSM2020[,9:ncol(VSM2020)] <- lapply(VSM2020[,9:ncol(VSM2020)],as.character)
VSM2021[,9:ncol(VSM2021)] <- lapply(VSM2021[,9:ncol(VSM2021)],as.character)
HM2020[,9:ncol(HM2020)] <- lapply(HM2020[,9:ncol(HM2020)],as.character)
HM2021[,9:ncol(HM2021)] <- lapply(HM2021[,9:ncol(HM2021)],as.character)
```

Fikser dato
```{r}
VSM2020$Dato <- as.POSIXct(as.Date(as.numeric(VSM2020$Dato),
                   origin = "1899-12-30"), 
           "%Y-%m-%d ")
# All dates should be the same
VSM2020$Dato <- VSM2020$Dato[1]
```
# Melt
```{r, warning=F}
setDT(VSM2021)
setDT(VSM2020)
setDT(HM2021)
setDT(HM2020)


VSM2021_melt = pivot_longer(VSM2021, cols=9:36, 
                            names_to="variable", values_to="value", 
                      values_drop_na = FALSE )
VSM2020_melt = pivot_longer(VSM2020, cols=9:33, 
                            names_to="variable", values_to="value", 
                      values_drop_na = FALSE )
HM2021_melt = pivot_longer(HM2021, cols=9:35, 
                            names_to="variable", values_to="value", 
                      values_drop_na = FALSE )
HM2020_melt = pivot_longer(HM2020, cols=9:33, 
                            names_to="variable", values_to="value", 
                      values_drop_na = FALSE )
```

Noen kolonne-navn forhindrer en sammenslåing av tabellene.
Dette gjelder kolonne-navn for artslister.
Navn 2021: Alle_arter
Navn 2020: Arter_tilstede
Samkjøre navnsetting for artslistene.
```{r}
names(VSM2021_melt)
names(VSM2020_melt)
names(HM2021_melt)
names(HM2020_melt)

names(VSM2020_melt)[names(VSM2020_melt) == "Arter_tilstede"] <- "Alle_arter"
names(VSM2020_melt)
names(HM2020_melt)[names(HM2020_melt) == "Arter_tilstede"] <- "Alle_arter"
names(HM2020_melt)
```
Mangler fortsatt en kolonne for HM2021 - Notat.
Må legge til denne.

```{r}
Notat <- NA
HM2021_melt <- cbind(HM2021_melt[,1:ncol(HM2021_melt)], Notat)
```


## Rydde
```{r}
rm(Helning,
   Registrert,
   Roughness,
   Notat)
```



# Compile

```{r}
dat <- rbind(
  VSM2021_melt,
  VSM2020_melt,
  HM2021_melt,
  HM2020_melt
)
```


```{r}
table(dat$Lokalitet, dat$Behandling)
```



```{r}
table(dat$Lokalitet[dat$Behandling=="S1"|
                      dat$Behandling=="S2"],
      dat$Sublokalitet[dat$Behandling=="S1"|
                      dat$Behandling=="S2"])
```
```{r}
table(dat$Sublokalitet[dat$Behandling=="S1"|
                      dat$Behandling=="S2"],
      dat$Blokk[dat$Behandling=="S1"|
                      dat$Behandling=="S2"])
```

Endrer S1 og S2 til rett kategori
```{r}
dat$Behandling <- gsub("S1", "SP1", dat$Behandling)
dat$Behandling <- gsub("S2", "SP2", dat$Behandling)
table(dat$Lokalitet, dat$Behandling)
```


Fikse dato - eksempler
```{r}
#temp <- format(dat$Dato, "%Y")
#temp <- format(dat$Dato, "%m")
#temp <- format(dat$Dato, "%d")
#temp <- format(dat$Dato, "%Y-%m-%d")

```

Den jeg vil bruke
```{r}
dat$Dato <- format(dat$Dato, "%Y-%m-%d")
```


Fikse <1-verdiene til 0.1
```{r}
dat$value[dat$value=="<1"] <- 0.1
head(dat$value)
```
Gjøre om NA til 0 i values.
Først sjekke om alle verdier stemmer.
```{r}
dat$valueTemp <- as.numeric(dat$value)
View(dat[is.na(dat$valueTemp),])
```

Deretter gjøre om NA til 0.
```{r}
dat$value[is.na(dat$value)] = 0

```

Ordne opp i datatyper for info-kolonner
```{r}
dat$Dato <- as.Date(dat$Dato)
dat$År <- format(dat$Dato, "%Y")
table(dat$Dato)

dat[,2:8] <- sapply(dat[,2:8],as.vector)

dat$value<- as.numeric(dat$value)

summary(dat$value)
```


# Plotting

```{r}
#boxplot Sphagnum
ggplot(data=dat[dat$variable=="Sphagnum",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() + geom_jitter(width=0.1,alpha=0.2)+
  facet_wrap(~Lokalitet)
```

```{r}
#boxplot Sphagnum
ggplot(data=dat[dat$variable=="Sphagnum",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot()+
  facet_wrap(~Lokalitet)
```
```{r}
#boxplot Sphagnum
ggplot(data=dat[dat$variable=="Sphagnum",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot()+
  xlab("Behandling")+
  ylab("Prosent dekke")+
  ggtitle("Dekning torvmoser")
```



Subsetting til en lokalitet
```{r}
dat_HM <- subset(dat, Lokalitet=="HM")
dat_VSM <- subset(dat, Lokalitet=="VSM")
```

boxplot Sphagnum en lokalitet
```{r}

ggplot(data=dat_HM[dat_HM$variable=="Sphagnum",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() + geom_jitter(width=0.1,alpha=0.2)+
  facet_wrap(~Sublokalitet)
```
```{r}
ggplot(data=dat_VSM[dat_VSM$variable=="Sphagnum",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() + geom_jitter(width=0.1,alpha=0.2)+
  facet_wrap(~Sublokalitet)
```
Boxplot bar torv
```{r}
#boxplot bare peat
ggplot(data=dat[dat$variable=="Bar_torv",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() + geom_jitter(width=0.1,alpha=0.2)+
  facet_wrap(~Lokalitet)
```
Boxplot bar torv for enkeltlokaliteter
```{r}
#boxplot bare peat
ggplot(data=dat_HM[dat_HM$variable=="Bar_torv",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() + geom_jitter(width=0.1,alpha=0.2)+
  facet_wrap(~Sublokalitet)
```

```{r}
#boxplot bare peat
ggplot(data=dat_VSM[dat_VSM$variable=="Bar_torv",], aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() + geom_jitter(width=0.1,alpha=0.2)+
  facet_wrap(~Sublokalitet)
```
Aggregere til annen vegetasjon enn Sphagnum
```{r}
dat_av <- subset(dat, variable!="Sphagnum" & variable!="Bar_torv" & variable!="Død_torvmose" & variable!="Strø" & variable!="Annet" & variable!="Halm" & variable!="Død_ved" & variable!="Mid_vann" & variable!="Død ved" & variable!="Sphagnum_strø")


table(dat_av$variable)

aggregate(dat_av$value, by=list(Behandling=dat_av$Behandling), FUN=sum)
aggregate(value ~ Behandling, dat_av, sum)

agg_dat_av <-aggregate(value ~ Behandling + Blokk + Sublokalitet + Lokalitet + År, FUN = sum, data=dat_av)

```

```{r}
#boxplot vegetasjon
ggplot(data=agg_dat_av, aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() + geom_jitter(width=0.1,alpha=0.2)+
  facet_wrap(~Lokalitet)
```


```{r}

ggplot(data=agg_dat_av, aes(x=Behandling, y=value, fill=År))+
  geom_boxplot() +
    xlab("Behandling")+
  ylab("Prosent dekke")+
  ggtitle("Dekning annen vegetasjon")
```


Oversikt tall annen vegetasjon
```{r}


```

...